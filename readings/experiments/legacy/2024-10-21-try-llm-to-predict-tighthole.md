# Predicting `tighthole` with an LLM

## Experiment Summary

Goal of the experiment is to see how accurately an LLM can classify a DDR (daily drilling report)
with the tag `tighthole`.

### Hypothesis

An LLM can grasp the meaning of the DDR text and accurately determine if the DDR describes a Tight Hole scenario.

### Measure of Success

Precision/recall/F1 on our current evaluation dataset for DDRs.

## Methodology

### Initial Plan

- Classify only `tighthole`, do not predict other tags.
- Use the model `gpt-4o-mini` that is much more affordable, faster, and seems to predict only slightly worse than `gpt-4o`.
- Give the LLM a definition of the Tight Hole tag available on the [InformatiQ Notion](https://informatiq.notion.site/Tag-categories-and-abbreviations-11a0158b598780f2a902d833083c39b5).
- Ask LLM to justify its decision in order to know why it makes mistakes and efficiently iterate on prompt engineering.

### Execution Details

Run the `2024-10-21-try-llm-to-predict-tighthole.ipynb` notebook with different `RUN_ID`-s.

Experimented with the prompt:

- Tried the Tight Hole definition from Notion (LLM run 1), but also a definition generated by GPT4 (LLM run 11).
- Tried explaining what actions the engineer can take to tackle the Tight Hole (LLM run 5).
- Tried giving examples (LLM run 11).
- Tried asking LLM for justification before making a choice (similar to a chain-of-thought approach).

Used a 0.25/0.75 split of the dataset into train/test, discarding the "test" and optimizing the prompt for the "train" part. Performance was tested it on the whole dataset.

This is not exactly correct (performance should've been measured on "test"), but the numbers must still be fair.
In all cases, performance on the whole dataset was really close to the performance on the train dataset.
Likely because the prompt always stayed generic, except the run 11 that included 4 examples from the train dataset verbatim.

## Results

We could achieve a higher recall than the current baseline solution.

|               | Precision | Recall   | F1 Score |
|---------------|-----------|----------|----------|
| Baseline      | **0.76**  | 0.90     | **0.83** |
| LLM run 1     | 0.49      | **0.98** | 0.65     |
| LLM run 5     | 0.38      | **1.00** | 0.55     |
| LLM run 7     | 0.51      | **0.95** | 0.67     |
| LLM run 11    | 0.36      | **0.96** | 0.53     |

We consider recall more important than precision.
With this in mind, perhaps the best-performing solution was LLM run 1.
It also had [the simplest prompt](#appendix-1---prompts).

Although the other runs with more elaborate prompts showed worse performance metrics,
the LLM justifications in them seemed to better describe the nuance in the reports.

Generally, across all runs we could increase recall at the expense of precision and vice versa, but not both at the same time.

One could optimize for recall by suggesting the LLM to tag records with insignificant/potential Tight Holes and optimize for precision by asking LLM to tag only when it's confident.

## Analysis

The evaluation dataset contains numerous items that can be ambiguously interpreted as a Tight Hole, depending on the specific definition applied.

The LLM also lacks understanding of the drilling phases (represented by the columns phase/code/subcode in the dataset) for accurately determining a Tight Hole scenario.

You can find some examples in [the appendix](#appendix-2---examples).

## Conclusion

We can tune the LLM model in order to achieve better recall than the baseline solution, but better precision needs more work.

The LLM demonstrates a good understanding of drilling reports and domain-specific language. However, it tends to interpret instructions literally. Therefore, it is essential to explicitly define the criteria for what constitutes a Tight Hole. The current evaluation dataset lacks clear criteria, resulting in suboptimal precision and recall.

For future evaluations, we would benefit from the following:

1. Updated evaluation dataset specifically for the `tighthole` tag. Assumption is, there are many ambiguous "maybe tight hole" DDRs that aren't tagged so.
2. Precise instructions of what constitutes a Tight Hole tag to tune LLM's "sensitivity" for such ambiguous DDRs.
3. Explain phases of drilling and types of equipment in the prompt. LLM does confuse the overpull when installing surface equipment with an overpull of the drill string, and we lacked the domain knowledge to correctly prompt about their difference.

## Appendix 1 - Prompts

LLM Run 1:

```text
You will be given a daily drilling report.
Please determine whether the situation "Tight Hole" is described in it.

Definition of "Tight Hole": Reduced wellbore diameter. The reason for this can be wellbore stability or geometrical challenges in the trajectory. It could also be due to mechanical issues where large equipment is ran into a small hole.

The drilling report where "Tight Hole" occured often mentions overpull (or OP for short), increased drag, or inability to pass through a tight spot.

Other situations that might occur during drilling: Lost Circulation, Hard Drilling, Wellbore Stability, Stuck Pipe, Well Control, Hole Cleaning, Boulders, Shallow Gas, Shallow Water, Wellbore Breathing, Pack-Off, Directional Control, Low ROP, High ROP, Downhole Equipment Failure, Wait, Surface Equipment Failure.
These situations may or may not occur at the same time with Tight Hole. Tight Hole should not be confused with them.

Respond in 2 lines:
1. write "tighthole" if the tag applies and "notag" if the tag doesn't apply.
2. write a justification of your choice.
```

_Prompts for the other runs you can find in the corresponding [evaluation reports](./3_evaluation_results)._

## Appendix 2 - Examples

_All examples for all runs you can find in the corresponding [evaluation reports](./3_evaluation_results)._

### Examples of false positives (LLM thinks it's Tight Hole, ground truth tells it's not)

```text
Drilled 9 1/2" section from 5464 m to 5468 m (stringer) with 2450 lpm, 300 bar, 90 - 130 rpm, 14 - 25 Kft.lbf and 5 - 15 ton WOB. Not possible to slide in.

--- LLM justification ---

The report indicates difficulty in sliding the drill string, which suggests resistance in the wellbore. This aligns with the characteristics of a Tight Hole scenario.
```

```text
Lubricated OOH from 5433 m to 5281 m with 400 lpm, 15 - 20 bar.
1897 m.

--- LLM justification ---

The report indicates the use of lubrication, which suggests an effort to ease movement through potential tight spots. This implies a Tight Hole scenario where additional measures are taken to facilitate drilling.
```

```text
Drilled cement from 1811 m to 1897 m w/ 1 - 7 mT WOB, 60 RPM, 5 - 8 kftlbs TQ, 3500 lpm, 269 - 256 bar.Increased the MW to 1.45 sg.Logged the pip tag at 1850.9 m.Drilled through the shoe at 1883 m, noted high torque spikes.  Worked and reamed across the shoe.Recovered 8 large pieces (4 x 6 x 8 cm) of plug assy from the shakers.Continued to drill cement through the rathole to 1897 m.

--- LLM justification ---

The report indicates high torque spikes and the need to work and ream across the shoe, suggesting resistance in the wellbore. This aligns with the characteristics of a Tight Hole scenario.
```

### Examples of false negatives (LLM thinks it's not Tight Hole, ground truth tells it is)

```text
Perform wireline run #5B according to program. When retracting from pre-test station at 4236.8 m experienced stuck tendencies. Stuck on cable, free after pulling with 12170 lbf. Decided to cancel the 3 last remaining pre-tests.   - Completed 54 stations, 9 good pre-tests. Struggled to achieve stable build up when recording pre-tests. - Well static throughout logging operations.

--- LLM justification ---

The report mentions stuck tendencies and pulling with significant force, but it does not indicate a reduced wellbore diameter or issues related to tight spots in the hole
```

```text
Main: Cleaned out rat hole in steps. Parameters: 800-2000 lpm/ 45-220 bar, 20-120 rpm/ 11-16 kNm and 0-8 ton WOB. Observed erratic pressure and pack-off tendencies. Aimed to limit pressure increase to max 25 bar above circulation pressure. Worked string with different parameters to remove obstruction.

--- LLM justification ---

The report does not mention reduced wellbore diameter, overpull, or increased drag, which are key indicators of a "Tight Hole" situation
```
